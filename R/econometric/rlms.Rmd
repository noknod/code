---
title: 'Заработная плата населения России (взаимно-оцениваемое задание: RMLS)'
output: html_document
lang: russian
---


### Описание начальных данных

- источник данных работы: «Российский мониторинг экономического положения и здоровья населения НИУ ВШЭ (RLMS-HSE)», проводимый Национальным исследовательским университетом - Высшей школой экономики и ЗАО «Демоскоп» при участии Центра народонаселения Университета Северной Каролины в Чапел Хилле и Института социологии РАН. (Сайты обследования RLMS-HSE: http://www.hse.ru/rlms, http://www.cpc.unc.edu/projects/rlms)». Данные взяты из репрезентативной выборки по индивидам за 2013 год - волна 22 (файл r22i_os25a.sav).

- из всего массива данных отобраны очищенные от пропущенных значений переменные:

```{r, message=FALSE, warning=FALSE}
library("rlms")

# чтение данных из файла
rd <- read.rlms("./r22i_os25a.sav")

# год проведения опроса для вычисления возраста
year <- 2013

# отбор нужных данных
ed <- data.frame("salary" = rd$rj13.2, "age" = year - rd$rh6,
                 "gender" = as.integer(factor(rd$rh5)) - 1, 
                 "education" = factor(rd$r_diplom),
                 "area" = rd$psu, "settlement.status" = rd$status, 
                 "staff" = replace(rd$rj6.0, is.na(rd$rj6.0), 0))

# очистка от пропущенных значений
ed <- na.omit(ed)
```

    1. rj13.2   - среднемесячная заработная плата,

    2. rh6      - год рождения,

    3. rh5      - пол (ЖЕНСКИЙ/МУЖСКОЙ),

    4. r_diplom - образование:

```{r, message=FALSE, warning=FALSE}
# только для отображения значений образования
levels(ed$education)
```

    5. psu      - номер региона (будет интересовать только отношение Москва/не Москва),

    6. status   - тип населённого пункта (областной центр, город, ПГТ, село), 

    7. rj6.0    - количество подчинённых.

- в дальнейшем исследовании участвуют только респонденты, давшие полные ответы.

```{r, message=FALSE, warning=FALSE}
index <- 
    ed$education %in% c('окончил 0 - 6 классов', 'незаконч среднее образование (7 - 8 кл)', 
                    'незаконч среднее образование (7 - 8 кл) + что-то еще', 
                    'законч среднее образование', 'законч среднее специальное образование', 
                    'законч высшее образование и выше')

ed <- ed[index, ]
```


### Обработка данных для исследования

Мы будем исследовать зависимость уровня заработной платы `salary` от следующих регрессоров:

- возраст (численный). Соотнесён с переменной `age`.

- пол (качественный). Соотнесён с фиктивной переменной `gender`, где 0 - мужской и 1 - женский.

- образование (качественный). В выборке этот регрессор принимает значения от 1 до 6. Однако разница влияния, к примеру, получения образования в виде 7-8 классов по сравнению с 0-6 классами явно отличается от разницы получения высшего образования по сравнению со средним специальным образованием, хотя оба примера - соседние категории. Поэтому рационально значения этой переменной заменить на 4 категории и ввести в набор данных четыре фиктивных (dummy) переменных `edu1`, `edu2`, `edu3`, `edu4`:

```{r, message=FALSE, warning=FALSE}
ed$edu1 = as.integer(ed$education %in% c('окончил 0 - 6 классов', 
                          'незаконч среднее образование (7 - 8 кл)',
                          'незаконч среднее образование (7 - 8 кл) + что-то еще'))
ed$edu2 = as.integer(ed$education == 'законч среднее образование')
ed$edu3 = as.integer(ed$education == 'законч среднее специальное образование')
ed$edu4 = as.integer(ed$education == 'законч высшее образование и выше')
```
                                                        edu1   edu2   edu3   edu4
    1. незаконченное среднее образование (1 до 3)         1      0      0      0
    2. законченное среднее образование (4)                0      1      0      0
    3. законченное среднее специальное образование (5)    0      0      1      0
    4. законченное высшее образование (6)                 0      0      0      1

Дополнительно добавим в модель два регрессора:

- тип населённого пункта (качественный). Очевидно, что доход работника зависит от места нахождения того или иного предприятия. Здесь выделим отдельно Москву, так как доходы в среднем  в Москве значительно превышают доходы в среднем по России. Тогда получим 5 категорий с соответствующими значениями фиктивных переменных (в этом случае закодируем вторым способом, когда все нулевые значения фиктивных переменных первых четырёх категорий означают пятую категорию):

```{r, message=FALSE, warning=FALSE}
ed$set1 = as.integer(ed$area != 'г. Москва' & ed$settlement.status == 'областной центр')
ed$set2 = as.integer(ed$area != 'г. Москва' & ed$settlement.status == 'город')
ed$set3 = as.integer(ed$area != 'г. Москва' & ed$settlement.status == 'ПГТ')
ed$set4 = as.integer(ed$area != 'г. Москва' & ed$settlement.status == 'село')
```
                                                         sel1    sel2    sel3   sel4
    1. областной центр                                     1       0       0      0
    2. город                                               0       1       0      0
    3. посёлок городского типа                             0       0       1      0
    4. село                                                0       0       0      1
    5. Москва                                              0       0       0      0

- количество подчинённых (численный). Вероятно, что с увеличением количества подчинённых возрастает ответственность занимаемой должности, что должно в свою очередь сказаться на доходе в сторону увеличения. Соотнесён с переменной `staff`.

```{r, message=FALSE, warning=FALSE}
# итоговые данные модели
data <- data.frame('salary'=ed$salary, 'age'=ed$age, 'gender'=ed$gender, 
                   'edu1'=ed$edu1, 'edu2'=ed$edu2, 'edu3'=ed$edu3, 'edu4'=ed$edu4, 
                   'set1'=ed$set1, 'set2'=ed$set2, 'set3'=ed$set3, 'set4'=ed$set4, 
                   'staff'=ed$staff)

# удаление из памяти лишних объектов
rm(rd, ed)
```

Окончательно получим набор данных, состоящий из `r dim(data)[2]` переменных и `r dim(data)[1]` записей.


### Описательные статистики

Предварительно посмотрим на статистическую информацию по полученным данным.

- для количественных переменных рассмотрим минимальное значение переменной `min`, максимальное значение `max`, среднее значение `mean`, медиану `median` и стандартное отклонение `st. dev.`:

```{r, message=FALSE, warning=FALSE}
# только для наглядного отображения статистик численных переменных
data.frame('статистика'=c('min', 'max', 'mean', 'median', 'st. dev.'),
           'зарплата'=c(min(data$salary), max(data$salary), mean(data$salary), 
                        median(data$salary), sqrt(var(data$salary))), 
           'возраст'=c(min(data$age), max(data$age), mean(data$age), 
                        median(data$age), sqrt(var(data$age))), 
           'подчинённые'=c(min(data$staff), max(data$staff), mean(data$staff), 
                median(data$staff), sqrt(var(data$staff))) )
```

- для качественных переменных подобная статистическая информация мало наглядна (например, не применимо понятие среднего значения, поскольку вычисление среднего предполагает сложение, а операция сложения для таких переменных не определена). Поэтому приведём таблицы соотношений каждого показателя к зарплате (на какие части от общей суммы дохода, равной `r format(sum(data$salary))`, делит то или иное значение показателя):

    1. пол: 

```{r, message=FALSE, warning=FALSE}
    xtabs(formula=salary~gender, data=data)
```

    2. образование: 

```{r, message=FALSE, warning=FALSE}
    ft <- xtabs(formula=salary~edu1 + edu2 + edu3 + edu4, data=data)
    ftable(ft)
```
   
    3. тип населённого пункта: 

```{r, message=FALSE, warning=FALSE}
    ft <- xtabs(formula=salary~set1 + set2 + set3 + set4, data=data)
    ftable(ft)
```

```{r, message=FALSE, warning=FALSE}
# только для показа расчёта показателей для сравнения
moscow_salary <- data[data$set4 + data$set3 + data$set2 + data$set1==0, ]$salary
total_salary <- data$salary
central_salary <- data[data$set1==1, ]$salary

m_t_l <- round(length(moscow_salary) / length(total_salary) * 100, 2)
m_t_s <- round(sum(moscow_salary) / sum(total_salary) * 100, 2)
c_t_l <- round(length(central_salary) / length(total_salary) * 100, 2)
c_t_s <- round(sum(central_salary) / sum(total_salary) * 100, 2)
```

    Заметим, что выделение Москвы в отдельную категорию себя оправдывает, ибо отношение количества респондентов из Москвы (`r length(moscow_salary)`) к общему числу составляет `r m_t_l`%, а отношение доходов составляет `r m_t_s`%. В то время как отношение количества респондентов из областных центров (`r length(central_salary)`) (которые по всей видимости должны обладать схожим уровнём доходов) составляет `r c_t_l`%, а отношение доходов составляет `r c_t_s`%. Разница в %-соотношениях наглядна.


### Графики

```{r, message=FALSE, warning=FALSE}
hist(data$salary, main='Гистограмма по доходу', xlab='доход', ylab='частота',
     breaks = 50, col = "lightblue")
```

На графике видно, что подавляющая часть доходов не превышает 20 000 руб. (в принципе, это показывала и медиана для зарплаты).

```{r, message=FALSE, warning=FALSE}
hist(data$age, main='Гистограмма для возраста', xlab='возраст', ylab='частота', 
     breaks = 10, col = "lightblue")
```

Из этого же графика можно судить, что выборкой охвачены в целом все возрасты работающих.


### Построение модели

Итак, переходим к построению линейной модели зависимости зарплаты от рассмотренных выше регрессоров методом наименьших квадратов (для образования за базовую категорию возьмём самый низкий уровень).

```{r, message=FALSE, warning=FALSE}
# построение модели
model <- lm(salary~age + gender + edu2 + edu3 + edu4 + set1 + set2 + set3 + set4 + staff, data=data)
```

Построенная модель имеет следующую таблицу характеристик:

```{r, message=FALSE, warning=FALSE}

# итоговые характеристики модели
summary(model)
```

Все переменные оказались значимыми на уровне 5% (`age`, `gender`, `edu2`, `edu3`, `edu4`, `set1`, `set2`, `set3`, `set4`, `staff`). Значения коэффициентов в целом совпадают с предварительными ожиданиями, а именно:

- возраст: вносит усреднёно незначительную долю, так как в выборке оказалось примерное равное количество всех возрастов работающих. Отрицательное значение скорее объясняется тем, что начиная с определённого возраста работодатель всё реже готов принять такого нового сотрудника, что снижает его стоимость.

- пол: (вспомним, что у нас значение 1 означает женский пол) получаем, что зарплата женщин при прочих равных заметно ниже, чем у мужчин.

- образование: более высокий уровень образования заметно влияет в сторону увеличения дохода.

- тип населённого пункта: значение и знак коэффициента подтверждают нашу гипотезу о том, что в Москве доходы значительно превышают доходы по России (ведь когда все переменные `set1`,  `set2`, `set3`, `set4` равны 0, это соответствует респонденту из Москвы). Так же видна положительная зависимость зарплаты от уровня значения населённого пункта.

- количество подчинённых: любопытно, что в данной модели эта переменная оказывает наименьшее влияние на итоговый доход. Здесь явно следует провести дополнительное исследование, и скорее всего, в данном случае мы имеем дело с 'выбросом'. Построим график с распределением зарплаты по количеству подчинённых:

```{r, message=FALSE, warning=FALSE}
# подключение необходимых библиотек
library('ggplot2')

# график с распределением зарплаты (логарифма) по количеству подчинённых
qplot(data=data, staff, log(salary), 
      xlab="Количество подчинённых, человек", ylab="Логарифм заработной платы")
```

Действительно, наблюдается довольно сильный 'выброс'.


### Модель с робастными ошибками

Теперь построим аналогичную модель, используя робастные ошибки.

```{r, message=FALSE, warning=FALSE}
# подключение необходимых библиотек
library('sandwich')
library('lmtest')

# расчёт коэффициентов с робастными ошибками
robust_model <- coeftest(model, vcov.=vcovHC(model, type="HC4"))
```

Рассмотрим характеристики для коэффициентов модели с робастными ошибками по сравнению с начальной моделью:

```{r, message=FALSE, warning=FALSE}
# функция для более наглядного отображения значимости коэффициентов на разных уровнях
get_coef_significance <- function(prt) {
    result <- c()
    for (element in prt) {
        if (element < 0.001) {result <- rbind(result, '***')}
        else if (element < 0.01) {result <- rbind(result, '**')}
        else if (element < 0.05) {result <- rbind(result, '.')}
        else if (element < 0.1) {result <- rbind(result, '+')}
        else {result <- rbind(result, '')}
    }
    result
}

# построение сравнительной таблицы
coef_model = coeftest(model)
comparison_table <- data.frame(
    round(coef_model[, 2], 2), round(robust_model[, 2] ,2), 
    round(coef_model[, 3], 2), round(robust_model[, 3], 2),
    round(coef_model[, 4], 5), round(robust_model[, 4], 5),
    get_coef_significance(coef_model[, 4]), 
    get_coef_significance(robust_model[, 4]))
names(comparison_table) = c('ст ош', 'ст ош_рб', 't ст', 't ст_рб', 
              'Pr(>|t|)', 'Pr_рб', 'знач', 'знач_рб')
comparison_table
```

(соответствие уровня значимости обозначено как `0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘+’ 1 ‘’`).

Полученные данные позволяют сделать вывод о том, что в результате использования робастных ошибок произошла корректировка значений стандартных ошибок (как и t-статистик). При этом  коэффициенты по-прежнему остались значимыми на уровне 5%, за исключением коэффициента при регрессоре, отвечающим за количество подчинённых `staff`. Последний же оказался вовсе незначим. Стандартные ошибки также изменили свое значение, одни в большую сторону (пол, количество подчинённых и тип населённого пункта) - следовательно, можно утверждать, что в исследуемых данных присутствует гетероскедастичность. Другие (возраст и образование) - в меньшую, что позволяет их теперь использовать в исследовании.

В итоге, учитывая результаты оценки составленной модели, остается вопрос об эффективном подборе переменных, влияющих на уровень дохода населения России в целом.